<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>회원가입</title>
    <style>
        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .btn {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        .btn-register {
            background-color: #4CAF50;
            color: white;
        }
        .btn-login {
            background-color: #2196F3;
            color: white;
        }
        .error-message {
            color: red;
            margin-top: 10px;
            display: none;
        }
        .password-requirements {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>회원가입</h1>
        <form id="register-form">
            <div class="form-group">
                <label for="id">아이디:</label>
                <input type="text" id="id" name="id" required minlength="5" maxlength="20">
                <button type="button" onclick="checkIdDuplicate()">중복 체크</button>
                <div id="idCheckResult"></div>
                <div class="password-requirements">아이디는 5자 이상 20자 이하로 입력해주세요.</div>
            </div>
            <div class="form-group">
                <label for="name">이름:</label>
                <input type="text" id="name" name="name" required minlength="2" maxlength="8">
                <div class="password-requirements">이름은 2자 이상 8자 이하로 입력해주세요.</div>
            </div>
            <div class="form-group">
                <label for="email">이메일:</label>
                <input type="email" id="email" name="email" required>
                <button type="button" onclick="checkEmailDuplicate()">중복 체크</button>
                <div id="emailCheckResult"></div>
            </div>
            <div class="form-group">
                <label for="password">비밀번호:</label>
                <input type="password" id="password" name="password" required>
                <div class="password-requirements">비밀번호는 대문자, 소문자, 숫자, 특수문자를 최소 한번씩 포함해서 8자 이상 20자 이하로 작성해주세요.</div>
            </div>
            <div id="error-message" class="error-message"></div>
            <button type="submit" class="btn btn-register">회원가입</button>
        </form>
        <button onclick="location.href='login'" class="btn btn-login">로그인으로 돌아가기</button>
    </div>

    <th:block th:replace="~{fragments/error :: script}"></th:block>

    <script th:inline="javascript">
        // 폼 제출 이벤트 리스너 추가
        document.getElementById('register-form').addEventListener('submit', handleSubmit);

        // 중복 체크 결과를 저장할 변수
        let isIdChecked = false;
        let isEmailChecked = false;

        async function checkIdDuplicate() {
            const id = document.getElementById('id').value;
            if(!id){
                showError('아이디를 입력해주세요')
                return false;
            }

            try {
                const response = await fetch(`/api/members/check-id?id=${encodeURIComponent(id)}`);
                const result = await response.json();
                let isValid = result.data;
                const resultDiv = document.getElementById('idCheckResult')
                if(isValid){
                    resultDiv.textContent = '사용 가능합니다'
                    resultDiv.style.color = 'green'
                    isIdChecked = true;
                }else{
                    resultDiv.textContent = '이미 사용 중입니다'
                    resultDiv.style.color = 'red'
                    isIdChecked = false;
                }
                return isValid;
            } catch (error) {
                showError('아이디 중복 체크중 오류가 발생했습니다.')
                console.error('아이디 중복 체크 중 오류 발생:', error);
                isIdChecked = false;
                return false;
            }
        }

        async function checkEmailDuplicate() {
            const email = document.getElementById('email').value;
            if(!email){
                showError('이메일을 입력해주세요')
                return false;
            }

            try {
                const response = await fetch(`/api/members/check-email?email=${encodeURIComponent(email)}`);
                const result = await response.json();
                let isValid = result.data;
                const resultDiv = document.getElementById('emailCheckResult')
                if(isValid){
                    resultDiv.textContent = '사용 가능합니다'
                    resultDiv.style.color = 'green'
                    isEmailChecked = true;
                }else{
                    resultDiv.textContent = '이미 사용 중입니다'
                    resultDiv.style.color = 'red'
                    isEmailChecked = false;
                }
                return isValid;
            } catch (error) {
                showError('이메일 중복 체크중 오류가 발생했습니다.')
                console.error('이메일 중복 체크 중 오류 발생:', error);
                isEmailChecked = false;
                return false;
            }
        }

        async function handleSubmit(event) {
            event.preventDefault();
            
            if (!validateForm()) {
                return false;
            }

            // 중복 체크 여부 확인
            if (!isIdChecked) {
                showError('아이디 중복 체크를 해주세요.');
                return false;
            }

            if (!isEmailChecked) {
                showError('이메일 중복 체크를 해주세요.');
                return false;
            }

            const formData = {
                id: document.getElementById('id').value,
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                password: document.getElementById('password').value
            };

            try {
                const response = await fetch('/api/members/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();

                if (response.ok) {
                    alert('회원가입이 완료되었습니다.');
                    window.location.href = '/members/login';
                } else {
                    showError(data.message || '회원가입에 실패했습니다.');
                }
            } catch (error) {
                showError('회원가입 중 오류가 발생했습니다.');
                console.error('회원가입 중 오류 발생:', error);
            }
        }

        function validateForm() {
            clearErrors();

            const id = document.getElementById('id').value;
            const name = document.getElementById('name').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (!id) {
                showFieldError('id', '아이디를 입력해주세요');
                return false;
            }

            if (!name) {
                showFieldError('name', '이름을 입력해주세요');
                return false;
            }

            if (!email) {
                showFieldError('email', '이메일을 입력해주세요');
                return false;
            }

            if (!password) {
                showFieldError('password', '비밀번호를 입력해주세요');
                return false;
            }

            // 비밀번호 유효성 검사 추가
            const passwordRegex = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*#?&])[A-Za-z\d@$!%*#?&]{8,20}$/;
            if (!passwordRegex.test(password)) {
                showFieldError('password', '비밀번호는 8~20자의 영문자, 숫자, 특수문자를 포함해야 합니다.');
                return false;
            }

            return true;
        }

        // 입력 필드 변경 시 중복 체크 상태 초기화
        document.getElementById('id').addEventListener('change', () => { isIdChecked = false; });
        document.getElementById('email').addEventListener('change', () => { isEmailChecked = false; });

    </script>
</body>
</html>